> create ts database sensors;
CREATE TS DATABASE
> use sensors;
SET
> create table sensors.sensor_data(
    ts timestamp not null,
    normal_time timestamp not null,
    temperature smallint,
    temperature2 int,
    temperature3 bigint,
    stress float4,
    stress2 double)
    tags (ptagID int not null) primary tags (ptagID);
CREATE TABLE
> INSERT INTO sensor_data (ts,normal_time,temperature,temperature2,temperature3,stress,stress2,ptagID) VALUES
('2024-12-01 1:00:00','2024-12-01 1:00:00', 1,100,1000,0.1,0.01,1),
('2024-12-01 2:00:00','2024-12-01 2:00:00', 2,200,2000,0.2,0.02,1),
('2024-12-01 3:00:00','2024-12-01 3:00:00', 3,300,3000,0.3,0.03,1),
('2024-12-01 4:00:00','2024-12-01 4:00:00', 4,400,4000,0.4,0.04,1),
('2024-12-01 5:00:00','2024-12-01 5:00:00', 5,500,5000,0.5,0.05,2),
('2024-12-01 6:00:00','2024-12-01 6:00:00', 6,600,6000,0.6,0.06,2),
('2024-12-01 7:00:00','2024-12-01 7:00:00', 7,700,7000,0.7,0.07,2),
('2024-12-01 8:00:00','2024-12-01 8:00:00', 8,800,8000,0.8,0.08,3),
('2024-12-01 9:00:00','2024-12-01 9:00:00', 9,900,9000,0.9,0.09,3),
('2024-12-01 10:00:00','2024-12-01 10:00:00', 10,1000,10000,1,0.1,3),
('2024-12-01 11:00:00','2024-12-01 11:00:00', -1,-100,-1000,-0.1,-0.01,5),
('2024-12-01 12:00:00','2024-12-01 12:00:00', 2,200,2000,0.2,0.02,5),
('2024-12-01 13:00:00','2024-12-01 13:00:00', -3,-300,-3000,-0.3,-0.03,5),
('2024-12-01 14:00:00','2024-12-01 14:00:00', 4,400,4000,0.4,0.04,5),
('2024-12-01 15:00:00','2024-12-01 15:00:00', -5,-500,-5000,-0.5,-0.05,5),
('2024-12-01 16:00:00','2024-12-01 16:00:00', -1,null,-1000,null,-0.01,6),
('2024-12-01 17:00:00','2024-12-01 17:00:00', null,null,2000,null,null,6),
('2024-12-01 18:00:00','2024-12-01 18:00:00', -3,null,-3000,null,null,6),
('2024-12-01 19:00:00','2024-12-01 19:00:00', 4,null,null,0.4,null,6),
('2024-12-01 20:00:00','2024-12-01 20:00:00', null,null,null,-0.5,-0.05,6);
INSERT 20
> select * from sensor_data order by ts;
             ts             |        normal_time        | temperature | temperature2 | temperature3 | stress | stress2 | ptagid
----------------------------+---------------------------+-------------+--------------+--------------+--------+---------+---------
  2024-12-01 01:00:00+00:00 | 2024-12-01 01:00:00+00:00 |           1 |          100 |         1000 |    0.1 |    0.01 |      1
  2024-12-01 02:00:00+00:00 | 2024-12-01 02:00:00+00:00 |           2 |          200 |         2000 |    0.2 |    0.02 |      1
  2024-12-01 03:00:00+00:00 | 2024-12-01 03:00:00+00:00 |           3 |          300 |         3000 |    0.3 |    0.03 |      1
  2024-12-01 04:00:00+00:00 | 2024-12-01 04:00:00+00:00 |           4 |          400 |         4000 |    0.4 |    0.04 |      1
  2024-12-01 05:00:00+00:00 | 2024-12-01 05:00:00+00:00 |           5 |          500 |         5000 |    0.5 |    0.05 |      2
  2024-12-01 06:00:00+00:00 | 2024-12-01 06:00:00+00:00 |           6 |          600 |         6000 |    0.6 |    0.06 |      2
  2024-12-01 07:00:00+00:00 | 2024-12-01 07:00:00+00:00 |           7 |          700 |         7000 |    0.7 |    0.07 |      2
  2024-12-01 08:00:00+00:00 | 2024-12-01 08:00:00+00:00 |           8 |          800 |         8000 |    0.8 |    0.08 |      3
  2024-12-01 09:00:00+00:00 | 2024-12-01 09:00:00+00:00 |           9 |          900 |         9000 |    0.9 |    0.09 |      3
  2024-12-01 10:00:00+00:00 | 2024-12-01 10:00:00+00:00 |          10 |         1000 |        10000 |      1 |     0.1 |      3
  2024-12-01 11:00:00+00:00 | 2024-12-01 11:00:00+00:00 |          -1 |         -100 |        -1000 |   -0.1 |   -0.01 |      5
  2024-12-01 12:00:00+00:00 | 2024-12-01 12:00:00+00:00 |           2 |          200 |         2000 |    0.2 |    0.02 |      5
  2024-12-01 13:00:00+00:00 | 2024-12-01 13:00:00+00:00 |          -3 |         -300 |        -3000 |   -0.3 |   -0.03 |      5
  2024-12-01 14:00:00+00:00 | 2024-12-01 14:00:00+00:00 |           4 |          400 |         4000 |    0.4 |    0.04 |      5
  2024-12-01 15:00:00+00:00 | 2024-12-01 15:00:00+00:00 |          -5 |         -500 |        -5000 |   -0.5 |   -0.05 |      5
  2024-12-01 16:00:00+00:00 | 2024-12-01 16:00:00+00:00 |          -1 | NULL         |        -1000 | NULL   |   -0.01 |      6
  2024-12-01 17:00:00+00:00 | 2024-12-01 17:00:00+00:00 | NULL        | NULL         |         2000 | NULL   | NULL    |      6
  2024-12-01 18:00:00+00:00 | 2024-12-01 18:00:00+00:00 |          -3 | NULL         |        -3000 | NULL   | NULL    |      6
  2024-12-01 19:00:00+00:00 | 2024-12-01 19:00:00+00:00 |           4 | NULL         |         NULL |    0.4 | NULL    |      6
  2024-12-01 20:00:00+00:00 | 2024-12-01 20:00:00+00:00 | NULL        | NULL         |         NULL |   -0.5 |   -0.05 |      6
(20 rows)
> select twa(ts, temperature) from sensor_data;
         twa
----------------------
  2.6388888888907727
(1 row)
> explain select twa(ts, temperature) from sensor_data;
        tree        |    field    |     description
--------------------+-------------+-----------------------
                    | distributed | true
                    | vectorized  | false
  group             |             |
   │                | aggregate 0 | twa(ts, temperature)
   │                | scalar      |
   └── sort         |             |
        │           | order       | +ts
        └── ts scan |             |
                    | ts-table    | sensor_data
                    | access mode | metaTable
(10 rows)
> select twa(ts, 1) from sensor_data;
  twa
-------
    1
(1 row)
> select twa(ts,1<<2) from sensor_data;
  twa
-------
    4
(1 row)
> select twa(ts, temperature+1) from sensor_data;
         twa
---------------------
  3.638888888900192
(1 row)
> select twa(ts, temperature-1) from sensor_data;
         twa
----------------------
  1.6388888888813538
(1 row)
> select twa(ts, temperature*2) from sensor_data;
         twa
---------------------
  5.277777777781545
(1 row)
> select twa(ts, cast(temperature/2 as float)) from sensor_data;
         twa
----------------------
  1.3194444444453863
(1 row)
> select twa(ts, temperature%2) from sensor_data;
          twa
------------------------
  -0.08333333333333333
(1 row)
> select twa(ts, temperature<<2) from sensor_data;
         twa
---------------------
  10.55555555556309
(1 row)
> select twa(ts, temperature>>2) from sensor_data;
  twa
--------
  0.25
(1 row)
> select twa(ts, temperature|2) from sensor_data;
         twa
---------------------
  3.583333333314495
(1 row)
> select twa(ts, temperature&2) from sensor_data;
         twa
----------------------
  1.0555555555555556
(1 row)
> select twa(ts, abs(temperature)) from sensor_data;
         twa
---------------------
  4.305555555555555
(1 row)
> select time_bucket(ts, '2h') as bucket,twa(ts, temperature) from sensor_data group by bucket order by bucket;
           bucket           |        twa
----------------------------+---------------------
  2024-12-01 00:00:00+00:00 |                  1
  2024-12-01 02:00:00+00:00 |                2.5
  2024-12-01 04:00:00+00:00 |                4.5
  2024-12-01 06:00:00+00:00 |                6.5
  2024-12-01 08:00:00+00:00 |                8.5
  2024-12-01 10:00:00+00:00 |  4.499999999966092
  2024-12-01 12:00:00+00:00 |               -0.5
  2024-12-01 14:00:00+00:00 |               -0.5
  2024-12-01 16:00:00+00:00 |                 -1
  2024-12-01 18:00:00+00:00 | 0.5000000000339084
  2024-12-01 20:00:00+00:00 | NULL
(11 rows)
> select max(temperature),min(temperature),first(temperature),last(temperature),lastts(temperature),twa(ts, temperature),elapsed(ts,1h) from sensor_data;
  max | min | first | last |          lastts           |        twa         | elapsed
------+-----+-------+------+---------------------------+--------------------+----------
   10 |  -5 |     1 |    4 | 2024-12-01 19:00:00+00:00 | 2.6388888888907727 |      19
(1 row)
> select max(temperature),min(temperature),first(temperature),last(temperature),lastts(temperature),twa(ts, temperature)+1,elapsed(ts,1h) from sensor_data;
  max | min | first | last |          lastts           |      ?column?      | elapsed
------+-----+-------+------+---------------------------+--------------------+----------
   10 |  -5 |     1 |    4 | 2024-12-01 19:00:00+00:00 | 3.6388888888907727 |      19
(1 row)
> select max(temperature),min(temperature),first(temperature),last(temperature),lastts(temperature),twa(ts, temperature)-1,elapsed(ts,1h) from sensor_data;
  max | min | first | last |          lastts           |      ?column?      | elapsed
------+-----+-------+------+---------------------------+--------------------+----------
   10 |  -5 |     1 |    4 | 2024-12-01 19:00:00+00:00 | 1.6388888888907727 |      19
(1 row)
> select max(temperature),min(temperature),first(temperature),last(temperature),lastts(temperature),twa(ts, temperature)*1,elapsed(ts,1h) from sensor_data;
  max | min | first | last |          lastts           |      ?column?      | elapsed
------+-----+-------+------+---------------------------+--------------------+----------
   10 |  -5 |     1 |    4 | 2024-12-01 19:00:00+00:00 | 2.6388888888907727 |      19
(1 row)
> select max(temperature),min(temperature),first(temperature),last(temperature),lastts(temperature),twa(ts, temperature)/1,elapsed(ts,1h) from sensor_data;
  max | min | first | last |          lastts           |      ?column?      | elapsed
------+-----+-------+------+---------------------------+--------------------+----------
   10 |  -5 |     1 |    4 | 2024-12-01 19:00:00+00:00 | 2.6388888888907727 |      19
(1 row)
> select max(temperature),min(temperature),first(temperature),last(temperature),lastts(temperature),twa(ts, temperature)%1,elapsed(ts,1h) from sensor_data;
  max | min | first | last |          lastts           |      ?column?      | elapsed
------+-----+-------+------+---------------------------+--------------------+----------
   10 |  -5 |     1 |    4 | 2024-12-01 19:00:00+00:00 | 0.6388888888907727 |      19
(1 row)
> select max(temperature),min(temperature),first(temperature),last(temperature),lastts(temperature),twa(ts, temperature)=1,elapsed(ts,1h) from sensor_data;
  max | min | first | last |          lastts           | ?column? | elapsed
------+-----+-------+------+---------------------------+----------+----------
   10 |  -5 |     1 |    4 | 2024-12-01 19:00:00+00:00 |  false   |      19
(1 row)
> select max(temperature),min(temperature),first(temperature),last(temperature),lastts(temperature),twa(ts, temperature)>1,elapsed(ts,1h) from sensor_data;
  max | min | first | last |          lastts           | ?column? | elapsed
------+-----+-------+------+---------------------------+----------+----------
   10 |  -5 |     1 |    4 | 2024-12-01 19:00:00+00:00 |   true   |      19
(1 row)
> select max(temperature),min(temperature),first(temperature),last(temperature),lastts(temperature),twa(ts, temperature)<1,elapsed(ts,1h) from sensor_data;
  max | min | first | last |          lastts           | ?column? | elapsed
------+-----+-------+------+---------------------------+----------+----------
   10 |  -5 |     1 |    4 | 2024-12-01 19:00:00+00:00 |  false   |      19
(1 row)
> select round(twa(ts, temperature),3) from sensor_data group by ptagID order by ptagID;
  round
----------
     2.5
       6
       9
       0
  -1.167
(5 rows)
> explain select twa(ts, temperature) from sensor_data group by ptagID order by ptagID;
             tree             |    field     |     description
------------------------------+--------------+-----------------------
                              | distributed  | true
                              | vectorized   | false
  render                      |              |
   │                          | twa          | twa
   └── sort                   |              |
        │                     | order        | +ptagid
        └── group             |              |
             │                | engine type  | time series
             │                | aggregate 0  | ptagid
             │                | aggregate 1  | twa(ts, temperature)
             │                | group by     | ptagid
             └── synchronizer |              |
                  └── ts scan |              |
                              | ts-table     | sensor_data
                              | ordered type | order scan
                              | access mode  | tableTableMeta
(16 rows)
> select round(twa(ts, temperature2),3) from sensor_data group by ptagID order by ptagID;
  round
---------
    250
    600
    900
      0
  NULL
(5 rows)
> select round(twa(ts, temperature3),3) from sensor_data group by ptagID order by ptagID;
  round
---------
   2500
   6000
   9000
      0
      0
(5 rows)
> select round(twa(ts, stress),3) from sensor_data group by ptagID order by ptagID;
  round
---------
   0.25
    0.6
    0.9
     -0
  -0.05
(5 rows)
> select round(twa(ts, stress2),3) from sensor_data group by ptagID order by ptagID;
  round
---------
  0.025
   0.06
   0.09
      0
  -0.03
(5 rows)
> select elapsed(ts,1h) from sensor_data group by ptagID having twa(ts, temperature) > 3 order by ptagID;
  elapsed
-----------
        2
        2
(2 rows)
> select elapsed(ts,1h) from sensor_data group by ptagID having twa(ts, temperature) > 3 and twa(ts, temperature) < 9 order by ptagID;
  elapsed
-----------
        2
(1 row)
> select time_bucket(ts, '2h') as bucket,twa(ts, temperature), elapsed(ts, 1h) from sensor_data group by bucket order by bucket;
           bucket           |        twa         | elapsed
----------------------------+--------------------+----------
  2024-12-01 00:00:00+00:00 |                  1 |       0
  2024-12-01 02:00:00+00:00 |                2.5 |       1
  2024-12-01 04:00:00+00:00 |                4.5 |       1
  2024-12-01 06:00:00+00:00 |                6.5 |       1
  2024-12-01 08:00:00+00:00 |                8.5 |       1
  2024-12-01 10:00:00+00:00 |  4.499999999966092 |       1
  2024-12-01 12:00:00+00:00 |               -0.5 |       1
  2024-12-01 14:00:00+00:00 |               -0.5 |       1
  2024-12-01 16:00:00+00:00 |                 -1 |       1
  2024-12-01 18:00:00+00:00 | 0.5000000000339084 |       1
  2024-12-01 20:00:00+00:00 | NULL               |       0
(11 rows)
> select twa(ts,(select temperature from sensor_data order by ts limit 1)) from sensor_data;
  twa
-------
    1
(1 row)
> select twa(ts,(select temperature from sensor_data order by ts limit 1)) from sensor_data group by ptagID order by ptagID;
  twa
-------
    1
    1
    1
    1
    1
(5 rows)
> select twa(ts,1) from sensor_data;
  twa
-------
    1
(1 row)
> select twa(ts,1+1%1) from sensor_data;
  twa
-------
    1
(1 row)
> select twa(ts,1) from sensor_data group by ptagID order by ptagID;
  twa
-------
    1
    1
    1
    1
    1
(5 rows)
> select twa(ts,1+1%1) from sensor_data group by ptagID order by ptagID;
  twa
-------
    1
    1
    1
    1
    1
(5 rows)
> select twa(ts,1.11) from sensor_data;
  twa
--------
  1.11
(1 row)
> select twa(ts,1.11) from sensor_data group by ptagID order by ptagID;
  twa
--------
  1.11
  1.11
  1.11
  1.11
  1.11
(5 rows)
> select elapsed(ts) from sensor_data;
  elapsed
------------
  6.84e+07
(1 row)
> select elapsed(ts,1w) from sensor_data;
       elapsed
----------------------
  0.1130952380952381
(1 row)
> select elapsed(ts,1d) from sensor_data;
       elapsed
----------------------
  0.7916666666666666
(1 row)
> select elapsed(ts,1h) from sensor_data;
  elapsed
-----------
       19
(1 row)
> select elapsed(ts,1m) from sensor_data;
  elapsed
-----------
     1140
(1 row)
> select elapsed(ts,1s) from sensor_data;
  elapsed
-----------
    68400
(1 row)
> select elapsed(ts,1ms) from sensor_data;
  elapsed
------------
  6.84e+07
(1 row)
> select elapsed(ts,1us) from sensor_data;
  elapsed
------------
  6.84e+10
(1 row)
> select elapsed(ts,1ns) from sensor_data;
  elapsed
------------
  6.84e+13
(1 row)
> select elapsed(ts)+1 from sensor_data;
    ?column?
-----------------
  6.8400001e+07
(1 row)
> select elapsed(ts)-1 from sensor_data;
    ?column?
-----------------
  6.8399999e+07
(1 row)
> select elapsed(ts)*2 from sensor_data;
  ?column?
-------------
  1.368e+08
(1 row)
> select elapsed(ts)/2 from sensor_data;
  ?column?
------------
  3.42e+07
(1 row)
> select elapsed(ts)%2 from sensor_data;
  ?column?
------------
         0
(1 row)
> select elapsed(ts)=2 from sensor_data;
  ?column?
------------
   false
(1 row)
> select elapsed(ts)!=2 from sensor_data;
  ?column?
------------
    true
(1 row)
> select elapsed(ts)>2 from sensor_data;
  ?column?
------------
    true
(1 row)
> select elapsed(ts)<2 from sensor_data;
  ?column?
------------
   false
(1 row)
> select elapsed(ts) from sensor_data group by ptagID order by ptagID;
  elapsed
------------
  1.08e+07
  7.2e+06
  7.2e+06
  1.44e+07
  1.44e+07
(5 rows)
> select elapsed(ts,1w) from sensor_data group by ptagID order by ptagID;
        elapsed
------------------------
  0.017857142857142856
  0.011904761904761904
  0.011904761904761904
  0.023809523809523808
  0.023809523809523808
(5 rows)
> select elapsed(ts,1d) from sensor_data group by ptagID order by ptagID;
        elapsed
-----------------------
                0.125
  0.08333333333333333
  0.08333333333333333
  0.16666666666666666
  0.16666666666666666
(5 rows)
> select elapsed(ts,1h) from sensor_data group by ptagID order by ptagID;
  elapsed
-----------
        3
        2
        2
        4
        4
(5 rows)
> select elapsed(ts,1m) from sensor_data group by ptagID order by ptagID;
  elapsed
-----------
      180
      120
      120
      240
      240
(5 rows)
> select elapsed(ts,1s) from sensor_data group by ptagID order by ptagID;
  elapsed
-----------
    10800
     7200
     7200
    14400
    14400
(5 rows)
> select elapsed(ts,1ms) from sensor_data group by ptagID order by ptagID;
  elapsed
------------
  1.08e+07
  7.2e+06
  7.2e+06
  1.44e+07
  1.44e+07
(5 rows)
> select elapsed(ts,1us) from sensor_data group by ptagID order by ptagID;
  elapsed
------------
  1.08e+10
  7.2e+09
  7.2e+09
  1.44e+10
  1.44e+10
(5 rows)
> select elapsed(ts,1ns) from sensor_data group by ptagID order by ptagID;
  elapsed
------------
  1.08e+13
  7.2e+12
  7.2e+12
  1.44e+13
  1.44e+13
(5 rows)
> select count(ts) from sensor_data group by ptagID having elapsed(ts,1h) > 3 order by ptagID;
  count
---------
      5
      5
(2 rows)
> select count(ts) from sensor_data group by ptagID having elapsed(ts,1h) > 3 or twa(ts,temperature) > 3 order by ptagID;
  count
---------
      3
      3
      5
      5
(4 rows)
> select elapsed(ts,1h)*twa(ts,temperature) from sensor_data;
      ?column?
---------------------
  50.13888888892468
(1 row)
> select elapsed(ts,1h)*twa(ts,temperature) from sensor_data group by ptagID order by ptagID;
         ?column?
--------------------------
                     7.5
                      12
                      18
  3.3908420138888887e-11
      -4.666666666621455
(5 rows)
> create table sensors.sensor_data2(
                                    ts timestamp not null,
                                    temperature smallint,
                                    temperature2 int,
                                    temperature3 bigint,
                                    stress float4,
                                    stress2 double)
    tags (ptagID int not null) primary tags (ptagID);
CREATE TABLE
> INSERT INTO sensor_data2 (ts, temperature,temperature2,temperature3,stress,stress2,ptagID) VALUES
('2024-12-01 1:00:00', 1,100,1000,0.1,0.01,1),
('2024-12-01 2:00:00', 2,200,2000,0.2,0.02,1),
('2024-12-01 3:00:00', 3,300,3000,0.3,0.03,1),
('2024-12-01 4:00:00', 4,400,4000,0.4,0.04,1),
('2024-12-01 5:00:00', 5,500,5000,0.5,0.05,2),
('2024-12-01 6:00:00', 6,600,6000,0.6,0.06,2),
('2024-12-01 7:00:00', 7,700,7000,0.7,0.07,2),
('2024-12-01 8:00:00', 8,800,8000,0.8,0.08,3),
('2024-12-01 9:00:00', 9,900,9000,0.9,0.09,3),
('2024-12-01 10:00:00', 10,1000,10000,1,0.1,3),
('2024-12-01 11:00:00', -1,-100,-1000,-0.1,-0.01,5),
('2024-12-01 12:00:00', 2,200,2000,0.2,0.02,5),
('2024-12-01 13:00:00', -3,-300,-3000,-0.3,-0.03,5),
('2024-12-01 14:00:00', 4,400,4000,0.4,0.04,5),
('2024-12-01 15:00:00', -5,-500,-5000,-0.5,-0.05,5),
('2024-12-01 16:00:00', -1, null,-1000,null,-0.01,6),
('2024-12-01 17:00:00', null, null,2000,null,null,6),
('2024-12-01 18:00:00', -3, null,-3000,null,null,6),
('2024-12-01 19:00:00', 4, null,null,0.4,null,6),
('2024-12-01 20:00:00', null,null,null,-0.5,-0.05,6);
INSERT 20
> select twa(temp.c3,temp.c4) from (
select s1.ts as c1,s1.temperature as c2, s2.ts as c3, s2.temperature as c4,s1.ptagid as c5, s2.ptagid as c6
from sensor_data as s1 inner join sensor_data2 as s2 on s1.ts=s2.ts) as temp
group by temp.c6 order by temp.c6;
           twa
-------------------------
                    2.5
                      6
                      9
  8.477105034722222e-12
    -1.1666666666553638
(5 rows)
> create database sensors_r;
CREATE DATABASE
> create table sensors_r.sensor_data_r(
                                    ts timestamp not null,
                                    normal_time timestamp not null,
                                    temperature smallint,
                                    temperature2 int,
                                    temperature3 bigint,
                                    stress float4,
                                    stress2 double,
                                    ptagID int not null);
CREATE TABLE
> INSERT INTO sensors_r.sensor_data_r (ts,normal_time,temperature,temperature2,temperature3,stress,stress2,ptagID) VALUES
('2024-12-01 1:00:00','2024-12-01 1:00:00', 1,100,1000,0.1,0.01,1),
('2024-12-01 2:00:00','2024-12-01 2:00:00', 2,200,2000,0.2,0.02,1),
('2024-12-01 3:00:00','2024-12-01 3:00:00', 3,300,3000,0.3,0.03,1),
('2024-12-01 4:00:00','2024-12-01 4:00:00', 4,400,4000,0.4,0.04,1),
('2024-12-01 5:00:00','2024-12-01 5:00:00', 5,500,5000,0.5,0.05,2),
('2024-12-01 6:00:00','2024-12-01 6:00:00', 6,600,6000,0.6,0.06,2),
('2024-12-01 7:00:00','2024-12-01 7:00:00', 7,700,7000,0.7,0.07,2),
('2024-12-01 8:00:00','2024-12-01 8:00:00', 8,800,8000,0.8,0.08,3),
('2024-12-01 9:00:00','2024-12-01 9:00:00', 9,900,9000,0.9,0.09,3),
('2024-12-01 10:00:00','2024-12-01 10:00:00', 10,1000,10000,1,0.1,3),
('2024-12-01 11:00:00','2024-12-01 11:00:00', -1,-100,-1000,-0.1,-0.01,5),
('2024-12-01 12:00:00','2024-12-01 12:00:00', 2,200,2000,0.2,0.02,5),
('2024-12-01 13:00:00','2024-12-01 13:00:00', -3,-300,-3000,-0.3,-0.03,5),
('2024-12-01 14:00:00','2024-12-01 14:00:00', 4,400,4000,0.4,0.04,5),
('2024-12-01 15:00:00','2024-12-01 15:00:00', -5,-500,-5000,-0.5,-0.05,5),
('2024-12-01 16:00:00','2024-12-01 16:00:00', -1,null,-1000,null,-0.01,6),
('2024-12-01 17:00:00','2024-12-01 17:00:00', null,null,2000,null,null,6),
('2024-12-01 18:00:00','2024-12-01 18:00:00', -3,null,-3000,null,null,6),
('2024-12-01 19:00:00','2024-12-01 19:00:00', 4,null,null,0.4,null,6),
('2024-12-01 20:00:00','2024-12-01 20:00:00', null,null,null,-0.5,-0.05,6);
INSERT 20
> select twa(ts, temperature) from sensors_r.sensor_data_r;
ERROR: twa function can only be used in time series table
SQLSTATE: 0A000
> select twa(normal_time, temperature) from sensors.sensor_data;
ERROR: first parameter should be primary timestamp in twa function
SQLSTATE: 42804
> select twa(normal_time_2, temperature) from sensors.sensor_data;
ERROR: column "normal_time_2" does not exist
SQLSTATE: 42703
> select twa(ts, ts) from sensors.sensor_data;
ERROR: unknown signature: twa(TIMESTAMPTZ(3), TIMESTAMPTZ(3))
SQLSTATE: 42883
> select twa(temp.c2, temp.c5) from (
     select s1.ts as c1,s1.normal_time as c2, s2.ts as c3, s2.temperature as c4,s1.ptagid as c5, s2.ptagid as c6
     from sensor_data as s1 inner join sensor_data2 as s2 on s1.ts=s2.ts) as temp
group by temp.c6 order by temp.c6;
ERROR: first parameter should be primary timestamp in twa function
SQLSTATE: 42804
> select twa(temp.c1, temp.c4) from (
      select s1.ts as c1,s1.normal_time as c2, s2.ts as c3, s2.temperature as c4,s1.ptagid as c5, s2.ptagid as c6
      from sensors_r.sensor_data_r as s1 inner join sensor_data2 as s2 on s1.ts=s2.ts) as temp
group by temp.c6 order by temp.c6;
ERROR: twa function can only be used in time series table
SQLSTATE: 0A000
> select twa(temp.c3, temp.c5) from (
      select s1.ts as c1,s1.normal_time as c2, s2.ts as c3, s2.temperature as c4,s1.ptagid as c5, s2.ptagid as c6
      from sensors_r.sensor_data_r as s1 inner join sensor_data2 as s2 on s1.ts=s2.ts) as temp
group by temp.c6 order by temp.c6;
  twa
-------
    1
    2
    3
    5
    6
(5 rows)
> select twa(temp.c1, temp.c5),twa(temp.c3, temp.c5) from (
      select s1.ts as c1,s1.normal_time as c2, s2.ts as c3, s2.temperature as c4,s1.ptagid as c5, s2.ptagid as c6
      from sensor_data as s1 inner join sensor_data2 as s2 on s1.ts=s2.ts) as temp
group by temp.c6 order by temp.c6;
  twa | twa
------+------
    1 |   1
    2 |   2
    3 |   3
    5 |   5
    6 |   6
(5 rows)
> explain select twa(temp.c1, temp.c5),twa(temp.c3, temp.c5) from (
      select s1.ts as c1,s1.normal_time as c2, s2.ts as c3, s2.temperature as c4,s1.ptagid as c5, s2.ptagid as c6
      from sensor_data as s1 inner join sensor_data2 as s2 on s1.ts=s2.ts) as temp
group by temp.c6 order by temp.c6;
                  tree                  |    field    |   description
----------------------------------------+-------------+------------------
                                        | distributed | true
                                        | vectorized  | false
  render                                |             |
   │                                    | twa         | twa
   │                                    | twa         | twa
   └── sort                             |             |
        │                               | order       | +ptagid
        └── group                       |             |
             │                          | aggregate 0 | ptagid
             │                          | aggregate 1 | twa(ts, ptagid)
             │                          | aggregate 2 | twa(ts, ptagid)
             │                          | group by    | ptagid
             └── sort                   |             |
                  │                     | order       | +ts,+ts
                  └── hash-join         |             |
                       │                | type        | inner
                       │                | equality    | (ts) = (ts)
                       ├── synchronizer |             |
                       │    └── ts scan |             |
                       │                | ts-table    | sensor_data
                       │                | access mode | tableTableMeta
                       └── synchronizer |             |
                            └── ts scan |             |
                                        | ts-table    | sensor_data2
                                        | access mode | tableTableMeta
(25 rows)
> select elapsed(ts) from sensors_r.sensor_data_r;
ERROR: elapsed function can only be used in time series table
SQLSTATE: 0A000
> select elapsed(normal_time) from sensors.sensor_data;
ERROR: first parameter should be primary timestamp in elapsed function
SQLSTATE: 42804
> select elapsed(c2) from (
      select s1.ts as c1,s1.normal_time as c2, s2.ts as c3, s2.temperature as c4,s1.ptagid as c5, s2.ptagid as c6
      from sensor_data as s1 inner join sensor_data2 as s2 on s1.ts=s2.ts) as temp
group by temp.c6 order by temp.c6;
ERROR: first parameter should be primary timestamp in elapsed function
SQLSTATE: 42804
> select elapsed(c3) from (
      select s1.ts as c1,s1.normal_time as c2, s2.ts as c3, s2.temperature as c4,s1.ptagid as c5, s2.ptagid as c6
      from sensors_r.sensor_data_r as s1 inner join sensor_data2 as s2 on s1.ts=s2.ts) as temp
group by temp.c6 order by temp.c6;
  elapsed
------------
  1.08e+07
  7.2e+06
  7.2e+06
  1.44e+07
  1.44e+07
(5 rows)
> select elapsed(c1) from (
      select s1.ts as c1,s1.normal_time as c2, s2.ts as c3, s2.temperature as c4,s1.ptagid as c5, s2.ptagid as c6
      from sensors_r.sensor_data_r as s1 inner join sensor_data2 as s2 on s1.ts=s2.ts) as temp
group by temp.c6 order by temp.c6;
ERROR: elapsed function can only be used in time series table
SQLSTATE: 0A000
> create table sensors.sensor_data_us(
    ts timestamp(6) not null,
    temperature smallint,
    temperature2 int,
    temperature3 bigint,
    stress float4,
    stress2 double)
    tags (ptagID int not null) primary tags (ptagID);
CREATE TABLE
> INSERT INTO sensor_data_us (ts, temperature,temperature2,temperature3,stress,stress2,ptagID) VALUES
('2024-12-01 1:00:00.000001', 1,100,1000,0.1,0.01,1),
('2024-12-01 2:00:00.000002', 2,200,2000,0.2,0.02,1),
('2024-12-01 3:00:00.000003', 3,300,3000,0.3,0.03,1),
('2024-12-01 4:00:00.000004', 4,400,4000,0.4,0.04,1),
('2024-12-01 5:00:00.000005', 5,500,5000,0.5,0.05,2),
('2024-12-01 6:00:00.000006', 6,600,6000,0.6,0.06,2),
('2024-12-01 7:00:00.000007', 7,700,7000,0.7,0.07,2),
('2024-12-01 8:00:00.000008', 8,800,8000,0.8,0.08,3),
('2024-12-01 9:00:00.000009', 9,900,9000,0.9,0.09,3),
('2024-12-01 10:00:00.000010', 10,1000,10000,1,0.1,3),
('2024-12-01 11:00:00.000011', -1,-100,-1000,-0.1,-0.01,5),
('2024-12-01 12:00:00.000012', 2,200,2000,0.2,0.02,5),
('2024-12-01 13:00:00.000013', -3,-300,-3000,-0.3,-0.03,5),
('2024-12-01 14:00:00.000014', 4,400,4000,0.4,0.04,5),
('2024-12-01 15:00:00.000015', -5,-500,-5000,-0.5,-0.05,5),
('2024-12-01 16:00:00.000016', -1, null,-1000,null,-0.01,6),
('2024-12-01 17:00:00.000017', null, null,2000,null,null,6),
('2024-12-01 18:00:00.000018', -3, null,-3000,null,null,6),
('2024-12-01 19:00:00.000019', 4, null,null,0.4,null,6),
('2024-12-01 20:00:00.000020', null,null,null,-0.5,-0.05,6);
INSERT 20
> select twa(ts, temperature) from sensor_data_us;
         twa
---------------------
  2.638888888912037
(1 row)
> select twa(ts, temperature) from sensor_data_us group by ptagID order by ptagID;
           twa
-------------------------
                    2.5
                      6
                      9
  5.208333331886574e-11
    -1.1666666666550927
(5 rows)
> select elapsed(ts) from sensor_data_us;
      elapsed
--------------------
  6.8400000019e+07
(1 row)
> select twa(normal_time, temperature) from sensor_data;
ERROR: first parameter should be primary timestamp in twa function
SQLSTATE: 42804
> select elapsed(normal_time) from sensor_data;
ERROR: first parameter should be primary timestamp in elapsed function
SQLSTATE: 42804
> select twa(ts+1s, temperature) from sensor_data_us;
ERROR: first parameter should be primary timestamp in twa function
SQLSTATE: 42804
> select twa(ts, '123') from sensor_data_us;
ERROR: unknown signature: twa(TIMESTAMPTZ(6), STRING)
SQLSTATE: 42883
> select twa(ts, temperature,3) from sensor_data_us;
ERROR: invalid parameter number in twa function
SQLSTATE: 42883
> select twa(ts, null) from sensor_data_us;
ERROR: ambiguous call: twa(TIMESTAMPTZ(6), UNKNOWN), candidates are:
twa(timestamptz, int) -> float
twa(timestamptz, float) -> float

SQLSTATE: 42725
> select twa(null, temperature) from sensor_data_us;
ERROR: first parameter should be primary timestamp in twa function
SQLSTATE: 42804
> select elapsed(null) from sensor_data_us;
ERROR: first parameter should be primary timestamp in elapsed function
SQLSTATE: 42804
> select elapsed(ts+1s) from sensor_data_us;
ERROR: first parameter should be primary timestamp in elapsed function
SQLSTATE: 42804
> select elapsed(ts,1w) from sensor_data_us;
        elapsed
-----------------------
  0.11309523812665344
(1 row)
> select elapsed(ts,1d) from sensor_data_us;
       elapsed
---------------------
  0.791666666886574
(1 row)
> select elapsed(ts,1h) from sensor_data_us;
       elapsed
----------------------
  19.000000005277776
(1 row)
> select elapsed(ts,1m) from sensor_data_us;
       elapsed
----------------------
  1140.0000003166667
(1 row)
> select elapsed(ts,1s) from sensor_data_us;
    elapsed
----------------
  68400.000019
(1 row)
> select elapsed(ts,1ms) from sensor_data_us;
      elapsed
--------------------
  6.8400000019e+07
(1 row)
> select elapsed(ts,1us) from sensor_data_us;
      elapsed
--------------------
  6.8400000019e+10
(1 row)
> select elapsed(ts,1ns) from sensor_data_us;
      elapsed
--------------------
  6.8400000019e+13
(1 row)
> create table sensors.sensor_data_ns(
   ts timestamp(9) not null,
   temperature smallint,
   temperature2 int,
   temperature3 bigint,
   stress float4,
   stress2 double)
   tags (ptagID int not null) primary tags (ptagID);
CREATE TABLE
> INSERT INTO sensor_data_ns (ts, temperature,temperature2,temperature3,stress,stress2,ptagID) VALUES
('2024-12-01 1:00:00.000000001', 1,100,1000,0.1,0.01,1),
('2024-12-01 2:00:00.000000002', 2,200,2000,0.2,0.02,1),
('2024-12-01 3:00:00.000000003', 3,300,3000,0.3,0.03,1),
('2024-12-01 4:00:00.000000004', 4,400,4000,0.4,0.04,1),
('2024-12-01 5:00:00.000000005', 5,500,5000,0.5,0.05,2),
('2024-12-01 6:00:00.000000006', 6,600,6000,0.6,0.06,2),
('2024-12-01 7:00:00.000000007', 7,700,7000,0.7,0.07,2),
('2024-12-01 8:00:00.000000008', 8,800,8000,0.8,0.08,3),
('2024-12-01 9:00:00.000000009', 9,900,9000,0.9,0.09,3),
('2024-12-01 10:00:00.000000010', 10,1000,10000,1,0.1,3),
('2024-12-01 11:00:00.000000011', -1,-100,-1000,-0.1,-0.01,5),
('2024-12-01 12:00:00.000000012', 2,200,2000,0.2,0.02,5),
('2024-12-01 13:00:00.000000013', -3,-300,-3000,-0.3,-0.03,5),
('2024-12-01 14:00:00.000000014', 4,400,4000,0.4,0.04,5),
('2024-12-01 15:00:00.000000015', -5,-500,-5000,-0.5,-0.05,5),
('2024-12-01 16:00:00.000000016', -1, null,-1000,null,-0.01,6),
('2024-12-01 17:00:00.000000017', null, null,2000,null,null,6),
('2024-12-01 18:00:00.000000018', -3, null,-3000,null,null,6),
('2024-12-01 19:00:00.000000019', 4, null,null,0.4,null,6),
('2024-12-01 20:00:00.000000020', null,null,null,-0.5,-0.05,6);
INSERT 20
> select twa(ts, temperature) from sensor_data_ns;
         twa
----------------------
  2.6388888888947375
(1 row)
> select twa(ts, temperature) from sensor_data_ns group by ptagID order by ptagID;
           twa
-------------------------
                    2.5
                      6
                      9
  1.777777777777284e-11
    -1.1666666666430092
(5 rows)
> select twa(ts, stress2) from sensor_data_ns group by ptagID order by ptagID;
           twa
--------------------------
                   0.025
                    0.06
                    0.09
  1.7777787314516002e-13
   -0.030000000000000002
(5 rows)
> select elapsed(ts) from sensor_data_ns;
        elapsed
-----------------------
  6.8400000000019e+07
(1 row)
> select elapsed(ts,1w) from sensor_data_ns;
        elapsed
-----------------------
  0.11309523809526952
(1 row)
> select elapsed(ts,1d) from sensor_data_ns;
       elapsed
----------------------
  0.7916666666668866
(1 row)
> select elapsed(ts,1h) from sensor_data_ns;
       elapsed
---------------------
  19.00000000000528
(1 row)
> select elapsed(ts,1m) from sensor_data_ns;
       elapsed
----------------------
  1140.0000000003167
(1 row)
> select elapsed(ts,1s) from sensor_data_ns;
      elapsed
-------------------
  68400.000000019
(1 row)
> select elapsed(ts,1ms) from sensor_data_ns;
        elapsed
-----------------------
  6.8400000000019e+07
(1 row)
> select elapsed(ts,1us) from sensor_data_ns;
        elapsed
-----------------------
  6.8400000000019e+10
(1 row)
> select elapsed(ts,1ns) from sensor_data_ns;
        elapsed
-----------------------
  6.8400000000019e+13
(1 row)
> CREATE TABLE t2 (k_timestamp TIMESTAMPTZ(3) NOT NULL,e1 INT4 NULL) TAGS ( size INT4 NOT NULL ) PRIMARY TAGS(size);
CREATE TABLE
> insert into t2 values('0001-11-06 17:10:23',1,1);
INSERT 1
> insert into t2 values('2025-06-06 11:15:15.783',1,1);
INSERT 1
> select elapsed(k_timestamp) from t2;
        elapsed
-----------------------
  6.3858045892783e+13
(1 row)
> create ts database test_twa_elapsed;
CREATE TS DATABASE
> create table test_twa_elapsed.tb2(k_timestamp timestamptz not null,id int not null,e1 timestamp,e2 int2,e3 int,e4 int8,e5 float4,e6 float8,e7 bool,e8 char,e9 char(100),e10 nchar,e11 nchar(255),e12 varchar,e13 varchar(254),e14 varchar(4096),e15 nvarchar,e16 nvarchar(255),e17 nvarchar(4096),e18 varbytes,e19 varbytes(100),e20 varbytes,e21 varbytes(254),e22 varbytes(4096),e23 timestamp(6),e24 timestamp(9),e25 timestamptz(6),e26 timestamptz(9)) tags (t1 int2 not null,t2 int,t3 int8,t4 bool,t5 float4,t6 float8,t7 char,t8 char(100) not null,t9 nchar,t10 nchar(254),t11 varchar,t12 varchar(128),t13 varbytes,t14 varbytes(100),t15 varbytes,t16 varbytes(255)) primary tags(t1,t8);
CREATE TABLE
> insert into test_twa_elapsed.tb2 values('1980-02-10 01:48:11.029+00:00',1,'2016-07-17 20:12:00.12+00:00',-100,1000,10000,100000.111,111110.101011,true,'a', 'a r3', 'a', 'test数据库语法查询测试！！！@TEST7-8', null, '数据库语法查询测试！！！@TEST7-8   ',null, 'a255{}', '查询测试！！！@TEST7-8','e','es1023_0', null, b'\xbb\xee\xff', null,null,'2001-01-26 12:16:16.161111','2029-10-18 21:21:33.211','2010-10-20 11:13:56.113','2008-10-06 22:20:22.566',7,null,1000,true,10.1011,100.123455,'a','test数据库语法查询测试！！！@TEST7-18','e','a',null,'test查询测试！！！@TEST7-18 ','b','test测试10_1','vwwws中文_1',null);
INSERT 1
> insert into test_twa_elapsed.tb2 values('1980-02-10 01:48:22.501+00:00',2,'1970-01-01 01:16:05.476+00:00',500,5000,60000,500000.505555,5000000.505055,false,'b','test数据库语法查询测 ','n','语法查询测试！！！@TEST7-8  ',null,null,'测试测试 ','@TEST1  ','abc255测试1()*&^%{}','deg4096测试1(','b','查询1023_2','tes_测试1',b'\xaa\xaa\xaa',b'\xbb\xcc\xbb\xbb','2011-01-23 03:36:16.161111','2029-10-20 10:20:58.986','2008-09-19 14:14:27.113','2018-08-18 18:18:22.188',-100,-500,-5000,true,-50.123123,500.578578,'c','test数据库查询测试！！！@TEST7-18  ','g','abc','test数据库语法查询测试！！！@TEST7-18','64_3','t','es1023_2','f','tes4096_2');
INSERT 1
> insert into test_twa_elapsed.tb2 values('2001-12-09 09:48:12.899',3,'2008-06-15 07:00:00',-300,3000,30000,300000.30312,3000000.3030303,false,'c', '\a r3', 'a', 'test数据库语法查询测试！','varchar  中文1', null, 'hof4096查询test%&!   ',null, 'ar255{}', 'ar96测试1%{}','e','es1023_0', null, b'\xcc\xee\xdd', null,'2011-08-21 23:16:16.885556','2001-07-20 05:55:45.117','2019-09-27 07:21:37.517','2008-09-30 11:11:12.168',6,300,3000,false,-33.123456,100.111111,'b','\\TEST1 ','f','test数据库语法查询测试！！！@TEST7-18','5555 5','  bdbd','y','test@测试！10_1','vwwws_1','cddde');
INSERT 1
> insert into test_twa_elapsed.tb2 values('2001-11-22 10:48:12.899',4,'2008-06-10 17:04:15.183',600,-6000,60000,600000.606666,6000000.606066,false,'c','test数据库语法查询测试！！！@TEST7-8 ','n','类型测试1()*  ',null,null,'255测试1cdf~# ','@TEST1  ','abc255测试1()*&^%{}','deg4096测试1(','b','查询1023_2','tes_测试1',b'\xaa\xaa\xaa',b'\xbb\xcc\xbb\xbb','2015-08-21 08:46:26.885556','2001-07-27 15:35:55.517','2025-10-21 09:51:30.477','2030-03-20 03:20:20.668',6,800,8000,false,-20.123,800.578578,'d','test测试！！！@TEST1  ','d','ddd','\0test查询！！！@TEST1\0','64_3','t','es1023_2','f','tes4096_2');
INSERT 1
> insert into test_twa_elapsed.tb2 values('2001-10-10 11:48:12.899',5,'2008-06-10 16:16:15.183',700,7000,70000,700000.707777,7000000.707077,true,'d','test数据库语法查询测试！！！@TEST7-8 ','d','类型测试1()*  ',null,null,'255测试1cdf~# ','@TEST1  ','abc255测试1()*&^%{}','deg4096测试1(','b','查询1023_2','tes_测试1',b'\xaa\xaa\xaa',b'\xbb\xcc\xbb\xbb','2015-08-21 22:22:26.885556','2001-07-27 05:15:35.517','2025-09-21 11:21:21.112','2030-03-27 11:11:12.168',7,-200,2000,false,-10.123,500.578578,'c','test测试！！！@TEST1  ','g','abc','\0test查询！！！@TEST1\0','64_3','t','es1023_2','f','tes4096_2');
INSERT 1
> select e1 from (select twa(k_timestamp,1) as val,e1 from test_twa_elapsed.tb2 group by e1) order by e1;
               e1
---------------------------------
  1970-01-01 01:16:05.476+00:00
  2008-06-10 16:16:15.183+00:00
  2008-06-10 17:04:15.183+00:00
  2008-06-15 07:00:00+00:00
  2016-07-17 20:12:00.12+00:00
(5 rows)
> explain select time_bucket_gapfill(e1,'5000mins') as tb from (select twa(k_timestamp,ln(t5)+ln(t6))*elapsed(k_timestamp,1ms) as val,e1 from test_twa_elapsed.tb2 group by e1 order by val) group by tb order by tb;
                  tree                  |    field    |                 description
----------------------------------------+-------------+-----------------------------------------------
                                        | distributed | true
                                        | vectorized  | false
  render                                |             |
   │                                    | tb          | time_bucket_gapfill_internal
   └── group                            |             |
        │                               | aggregate 0 | tb
        │                               | aggregate 1 | time_bucket_gapfill_internal(e1, '5000mins')
        │                               | group by    | tb
        │                               | ordered     | +tb
        └── sort                        |             |
             │                          | order       | +tb
             └── render                 |             |
                  │                     | '5000mins'  | '5000mins'
                  │                     | tb          | time_bucket_gapfill(e1, '5000mins')
                  │                     | e1          | e1
                  └── distinct          |             |
                       │                | distinct on | e1
                       └── synchronizer |             |
                            └── ts scan |             |
                                        | ts-table    | tb2
                                        | access mode | metaTable
(21 rows)
> select time_bucket(e1,'5000mins') as tb from (select twa(k_timestamp,ln(t5)+ln(t6))*elapsed(k_timestamp,1ms) as val,e1 from test_twa_elapsed.tb2 group by e1 order by val) group by tb order by tb;
             tb
-----------------------------
  1969-12-29 17:20:00+00:00
  2008-06-09 09:20:00+00:00
  2008-06-12 20:40:00+00:00
  2016-07-15 17:20:00+00:00
(4 rows)
> select time_bucket(e23,'5000mins') as tb from (select twa(k_timestamp,log(e5)+log(e6))*elapsed(k_timestamp,'1') as val,e23 from test_twa_elapsed.tb2 group by e23 order by val,e23) group by tb order by tb;
             tb
-----------------------------
  2001-01-26 10:00:00+00:00
  2011-01-20 06:00:00+00:00
  2011-08-20 01:20:00+00:00
  2015-08-20 20:40:00+00:00
(4 rows)
> SELECT twa(ts, temperature) over (partition by ptagid) from sensors.sensor_data;
ERROR: twa() is not supported as a window function
SQLSTATE: 0A000
> SELECT elapsed(ts) over (partition by ptagid) from sensors.sensor_data;
ERROR: elapsed() is not supported as a window function
SQLSTATE: 0A000
> drop database sensors cascade;
DROP DATABASE
> drop database sensors_r cascade;
DROP DATABASE
> drop database test_twa_elapsed cascade;
DROP DATABASE
